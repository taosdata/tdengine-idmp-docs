name: IDMP docs Workflow

on:
  push:
    branches:
      - 'test/yangliang/arc'
    paths:
      - '.github/workflows/arc-build-docs.yaml'
  workflow_dispatch:
    inputs:
      branch:
        description: "Enter your branch here"
        required: false
        default: ''
        type: string

concurrency:
  group: ${{ github.ref }}-tdengine-idmp-docs-build
  cancel-in-progress: true

jobs:
  build:
    runs-on: tdengine-idmp-docs-build

    env:
      NODE_VERSION: '24'
      PNPM_VERSION: '10'
      PYTHON_VERSION: '3.10'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: taosdata/tdengine-idmp-docs
          path: tdengine-idmp-docs
          ref: ${{ github.event.inputs.branch || github.ref_name }}
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false 

      - name: Set Env
        run: |
          echo "VERSION=latest" >> $GITHUB_ENV
          echo "DOCS_TYPE=tdasset" >> $GITHUB_ENV

      - name: generate version config
        run: |
          cd tdengine-idmp-docs;python3 .github/scripts/generate_version.py \
            $(git tag | egrep "v(.*)$" | xargs echo -n) > \
            test_versions.json
          cat test_versions.json

      - name: Build Docs
        run: |
          cd tdengine-idmp-docs
          pnpm install
          pnpm run build
          
      - name: Create Dockerfile
        run: |
          cd tdengine-idmp-docs
          cat > Dockerfile << 'EOF'
          # 使用官方的Nginx镜像作为基础
          FROM nginx:alpine
          
          # 将当前目录下的build文件夹复制到Nginx的默认静态文件目录
          COPY build/ /usr/share/nginx/html/
          
          # 暴露80端口
          EXPOSE 80
          
          # Nginx容器启动时自动运行nginx
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Verify Dockerfile
        run: cd tdengine-idmp-docs && cat Dockerfile

      - name: build docker image
        run: |
          cd tdengine-idmp-docs
          pwd
          ls -l
          CLEAN_BRANCH=$(echo ${{ github.event.inputs.branch || github.ref_name }} | sed 's/[^a-zA-Z0-9.-]/-/g' | tr '[:upper:]' '[:lower:]')
          docker -H docker-dind.default:2375 build . -t ${{ vars.LOCAL_DOCKER_REGISTRY_URL }}/library/tdengine-idmp-docs:idmp-docs$CLEAN_BRANCH
          docker -H docker-dind.default:2375 push ${{ vars.LOCAL_DOCKER_REGISTRY_URL }}/library/tdengine-idmp-docs:idmp-docs$CLEAN_BRANCH

  deploy:
    runs-on: tdengine-idmp-docs-deploy
    needs: build
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ vars.TAOSDATA_BOT_ID }}
          private_key: ${{ secrets.TAOSDATA_BOT_KEY }}
            
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: taosdata/platform-group
          path: platform-group
          ref: "test/yangliang/arc"
          token: ${{ steps.app-token.outputs.token }}
          
      - name: deploy project to dev env
        run: |
          cd platform-group/helm/idmp-docs
          CLEAN_BRANCH=$(echo ${{ github.event.inputs.branch || github.ref_name }} | sed 's/[^a-zA-Z0-9.-]/-/g' | tr '[:upper:]' '[:lower:]')
          /home/runner/k8stool/helm upgrade --install --namespace td-dev --set name=idmp-docs$CLEAN_BRANCH --set image=${{ vars.LOCAL_DOCKER_REGISTRY_URL }}/library/tdengine-idmp-docs:idmp-docs$CLEAN_BRANCH idmp-docs$CLEAN_BRANCH ./ --kubeconfig /home/runner/k8stool/config
          echo "Visit idmp-docs$CLEAN_BRANCH.kube.tdengine.net to check deployment"
