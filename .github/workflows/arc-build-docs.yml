name: ARC IDMP docs Workflow

on:
  push:
    branches:
      - '*-deploy'
  workflow_dispatch:
    inputs:
      branch:
        description: "Enter your branch here"
        required: false
        default: ''
        type: string

concurrency:
  group: ${{ github.ref }}-tdengine-idmp-docs-build
  cancel-in-progress: true

jobs:
  build:
    runs-on: tdengine-idmp-docs-build

    env:
      NODE_VERSION: '24'
      PNPM_VERSION: '10'
      PYTHON_VERSION: '3.10'

    steps:
      - name: Checkout Code
        run: |
          BRANCH=${{ github.event.inputs.branch || inputs.branch_name || github.ref_name }}
          cp -r /public/source_codes/tdengine-idmp-docs .
          cd tdengine-idmp-docs
          git pull
          git checkout $BRANCH

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false 

      - name: Set Env
        run: |
          echo "VERSION=latest" >> $GITHUB_ENV
          echo "DOCS_TYPE=tdasset" >> $GITHUB_ENV

      - name: generate version config
        run: |
          cd tdengine-idmp-docs;python3 .github/scripts/generate_version.py \
            $(git tag | egrep "v(.*)$" | xargs echo -n) > \
            test_versions.json
          cat test_versions.json

      - name: Build Docs
        run: |
          cd tdengine-idmp-docs
          pnpm install
          pnpm run build
          
      - name: Create Dockerfile
        run: |
          cd tdengine-idmp-docs
          cat > Dockerfile << 'EOF'
          # 使用官方的Nginx镜像作为基础
          FROM nginx:alpine
          
          # 将当前目录下的build文件夹复制到Nginx的默认静态文件目录
          COPY build/ /usr/share/nginx/html/
          
          # 暴露80端口
          EXPOSE 80
          
          # Nginx容器启动时自动运行nginx
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Verify Dockerfile
        run: cd tdengine-idmp-docs && cat Dockerfile

      - name: build docker image
        run: |
          cd tdengine-idmp-docs
          pwd
          ls -l
          CLEAN_BRANCH=$(echo ${{ github.event.inputs.branch || inputs.branch_name || github.ref_name }} | sed 's/[^a-zA-Z0-9.-]/-/g' | tr '[:upper:]' '[:lower:]')
          docker -H docker-dind.default:2375 build . -t ${{ vars.LOCAL_DOCKER_REGISTRY_URL }}/library/tdengine-idmp-docs:idmp-docs-$CLEAN_BRANCH
          docker -H docker-dind.default:2375 push ${{ vars.LOCAL_DOCKER_REGISTRY_URL }}/library/tdengine-idmp-docs:idmp-docs-$CLEAN_BRANCH

  deploy:
    runs-on: tdengine-idmp-docs-deploy
    needs: build
    steps:
      - name: deploy project to dev env
        run: |
          cd /public/platform-group/helm/idmp-docs
          CLEAN_BRANCH=$(echo ${{ github.event.inputs.branch || inputs.branch_name || github.ref_name }} | sed 's/[^a-zA-Z0-9.-]/-/g' | tr '[:upper:]' '[:lower:]')
          /home/runner/k8stool/helm upgrade --install --namespace td-dev --set name=idmp-docs-$CLEAN_BRANCH --set image=${{ vars.LOCAL_DOCKER_REGISTRY_URL }}/library/tdengine-idmp-docs:idmp-docs-$CLEAN_BRANCH idmp-docs-$CLEAN_BRANCH ./ --kubeconfig /home/runner/k8stool/config
          echo "Visit idmp-docs-$CLEAN_BRANCH.kube.tdengine.net to check deployment"

      - name: Send Feishu Message to CI Info Group
        if: success()
        run: |
          function post_to_feishu() {
            local text="$1"
            local BRANCH="$2"
            curl -X POST -H "Content-Type: application/json" \
            -d @- https://open.feishu.cn/open-apis/bot/v2/hook/7d20c281-d937-4a24-9880-e5bb5900b817 <<EOF
            {
                "msg_type": "text",
                "content": {
                "text": "$text"
                }
            }
          EOF
          }

          PR_INFO="Visit idmp-docs-$BRANCH.kube.tdengine.net to check deployment\n
          Workflow：https://github.com/taosdata/tdengine-idmp-docs/actions/runs/${{ github.run_id }}\n"

          CLEAN_BRANCH=$(echo ${{ github.event.inputs.branch || inputs.branch_name || github.ref_name }} | sed 's/[^a-zA-Z0-9.-]/-/g' | tr '[:upper:]' '[:lower:]')
          post_to_feishu "$PR_INFO @${{ github.actor }}" $CLEAN_BRANCH

      - name: Send Feishu Message to CI Info Group
        if: failure()
        run: |
          function post_to_feishu() {
            local text="$1"
            curl -X POST -H "Content-Type: application/json" \
            -d @- https://open.feishu.cn/open-apis/bot/v2/hook/7d20c281-d937-4a24-9880-e5bb5900b817 <<EOF
            {
                "msg_type": "text",
                "content": {
                "text": "$text"
                }
            }
          EOF
          }

          PR_INFO="pipeline failed deployment\n
          Workflow：https://github.com/taosdata/tdengine-idmp-docs/actions/runs/${{ github.run_id }}\n"

          post_to_feishu "$PR_INFO @${{ github.actor }}"
