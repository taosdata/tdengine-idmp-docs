# TDgpt 预测与补全

IDMP 可以充分利用 TDgpt 的能力，将预测数据追加到趋势图上，或者将缺失的数据补全。

## 预测数据

时序数据预测分析以持续一个时间段的时序数据作为输入，预测接下一个连续时间区间内时间序列数据趋势，并且用户可以指定输出的时间序列数据点数量。IDMP 面板中可以对某一个指标开启预测来启用此功能。

### 开启预测

每一个指标都可以单独开启预测，如下图所示。开启预测的指标，其他配置项需要保持默认值，如果使用复杂表达式或者函数等，则无法进行正确的预测。

![开启预测](./images/forecast-trigger.png)

如下图，点击预测列中的按钮后弹出算法配置表单。

1. 算法：数据预测采用的算法，请选择 anode 部署的可用算法；
2. 采样间隔：预测数据的采样间隔；
3. 未来数据持续时间：决定了预测结果的记录数（未来数据持续时间/采样间隔）；
4. 历史数据持续时间：算法取用的样本记录数；
5. 置信水平：预测数据的置信区间范围，取值范围调整为 (0, 1]。
6. 协变量：可选参数。可选择当前面板中其他指标作为协变量参与预测计算，目前仅 moirai 预测算法支持。

![预测算法](./images/forecast-algo.png)

### 预测结果

如图，每一个采样时间点会有三个值，分别对应置信区间上界 (_low)、均值 (_mean)、下界 (_high)。

![预测结果](./images/forecast-result.png)

## 补全数据

TDengine TSDB（从 v3.3.7.7 版本开始）提供基于时序基础模型的缺失数据补值功能，IDMP 趋势图中通过简单的操作就可以在图上实现补齐数据。

### 数据缺失识别

如图，在趋势图中出现类似这样的曲线，则说明可能存在一定的数据丢失问题。

![数据缺失](./images/imputation-show.png)

### 数据补全操作及算法参数配置

点击`缺失值填补`按钮后，可以在趋势图中按下鼠标来选择填补区域，选择的区域需要在缺失部分前后包含一定范围的现存数据，以便反映趋势变化，补全算法才能更加有依据去补全数据。

![触发数据补全](./images/imputation-trigger.png)

选择补全区域后，则弹出补全算法配置表单，填充后可提交获取补全数据。补全算法参数有：

1. 待补全指标：从当前指标中选择，支持多选；
2. 算法：目前仅支持 moment 算法；
3. 采样间隔：当连续两个数据采样点间隔大于 2 个采样间隔则认为有数据缺失，会进行数据填补。
4. 启用白噪音检查：开启后会进行白噪声检查，如果选择的现有数据点过少，算法无法拟合到有效规律，则会认为数据是随机值，直接报错。

![数据补全算法](./images/imputation-algo.png)

### 数据补全结果展示

如图，补全的数据会在同一条曲线上以红色高亮展示。如果对补齐结果不满意，则可以点击`重置补全`按钮，放弃当前补全结果。可以重新进行补全操作，**适当扩大选择的数据范围**，以获得更好的补全结果。

![数据补全结果](./images/imputation-succ.png)

``` text
tip：后续版本将支持将补全结果写回到 TDengine 数据库中，敬请期待。
```

## 常见错误

1. TDengine ERROR (0x445): Analysis failed since anode return error，此错误说明 moment 服务未正确部署或者执行失败，数据补全报错。请检查 anode 节点上 moment-server 是否正常；如果 moment-server 正常，则可以适当选择的时间范围，重新进行数据补全。
2. TDengine ERROR (0x441): Analysis service can't access，此错误表明 TDgpt anode 节点没有启动，数据补全报错。
3. TDengine ERROR (0x443): Analysis algorithm/model not loaded，此错误表明 TDgpt 相关的预测算法服务未部署。
