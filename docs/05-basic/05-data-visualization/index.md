# 数据可视化

IDMP 内置了 Grafana 风格的数据可视化 (Data Visualization) 模块，它提供面板和看板。看板由一系列的面板组成，全部是拖拽操作，操作简单直接，本文档不做任何专门介绍。

任何一个元素都可以有自己的面板和看板。对于树状结构里的每个元素，因为所处层次的不同，不同层次的元素关心的指标会不一样。比如电力集团一级的面板关心的是整个集团的总发电量、总成本等，而到风机一级，关心的是这台风机的状态、发电效率等。IDMP 的这种设计适合企业管理的架构。

## 面板的基本操作

IDMP 面板支持趋势图、柱状图、饼图、仪表盘、统计值、富文本、表格等，后续还将支持散点图、地图、组态、热力图、事件分析图等。
查看面板时，点击面板上方的动作区的图标，您可以编辑、收藏、设置显示的时间段范围、刷新的频次、下载为图片，也可以放大某一显示区域、全屏展示等。面板的下方是图例，点击它可以隐藏或显示某个指标。
点击编辑按钮，对面板进行编辑。下面对面板的编辑操作做较为详细的介绍。

## 面板展示的数据类型

一个元素自身有很多属性，这些属性可以展示出来。同时，一个元素可能有多个子元素，子元素的子元素等，这些子元素之间的聚合计算会产生很多新的指标，也可以展示出来。因此在创建一个元素的面板时，在左侧树状结构区，您可以选择：

1. **元素**：您可以选择本元素的属性，也可以选择该元素下面的子元素的属性作为展示的指标。但系统仅仅列出数据引用为 TDengine Metric 的属性，因为他们才是时序类数据，需要展示。
2. **子元素聚合**：您可以选择本元素所拥有的子元素的子元素模板，然后选择对这个子元素模板的哪个属性进行聚合，同时可以选择一个或多个维度指标。

缺省的选择是`元素`。在左侧树状结构，选择一个具体指标或标签，鼠标双击就行。同时您也可以点击其右边的三个点，选择"添加到指标"或"添加到维度"。

## 面板指标 (Mertrics) 的配置

您可以对每个被选中的指标做如下的配置：

1. **名称 (Name)**：面板上展示的指标名称，默认为属性名。
2. **表达式 (Expression)**：支持在选中的属性上进行表达式计算，也可选择多个属性进行计算。
3. **计量单位 (UOM)**：设置指标的显示单位，可调整为同一计量类别下的其他单位。
4. **过滤条件 (Conditions)**：对原始数据进行过滤，以筛选所需数据。
5. **时间偏移 (Time Shift)**：将被展示的指标的时间戳进行偏移，用于不同时间段的趋势对比。比如设置为 -1d，表示展示的是该指标一天前对应的数据。
6. **预测 (Prediction)**：点击可以对该指标进行时序数据预测的设置
7. **排序 (Order by)**：点击可以选择对指标进行排序，缺省是不排。

对于所有展示的指标，在指标列表的右上角，您还可以设置：

1. **窗口 (Window)**：对指标进行滑动窗口的聚合，您可以设置滑动时长以及聚合窗口的时长，缺省是不设置。
2. **限制 (Limit)**：限制指标数据展示的最大条数
3. **查看 SQL**：您可以打开查看当前指标和维度生成的实际 SQL 语句。

## 面板维度 (Dimensions) 的配置

在左侧树状结构里，选择一个维度（标签），鼠标点击，即被选中。您可以对维度做如下配置：

1. **名称 (Name)**：这是在 Panel 上展示的指标的名字，缺省就是属性的名字。
2. **表达式 (Expression)**：这里表示可以使用维度进行计算后再作为维度显示在面板中。
3. **过滤条件 (Conditions)**：对维度值进行过滤的条件，以筛选维度。
4. **分组 (Group by)**：以维度为组进行聚合，缺省是打开。
5. **排序 (Order by)**：点击可以选择对维度进行排序，缺省是不排。

:::note
tbname 作为特殊的维度，如何表达式为空，只会作为分组和排序使用，不返回到面板的维度里面。
:::

## 面板指标或者维度的操作

在指标或维度列表中，每一行项目都支持以下操作：

1. **删除 (Delete)**：移除当前指标或维度，删除后无法恢复，请谨慎操作。
2. **上移 (Up)**：将指标或维度向上移动，可以改变其在图表中的显示顺序。
3. **下移 (Down)**：将指标或维度向下移动，可以改变其在图表中的显示顺序。

:::tip
通过调整指标或维度的显示顺序，可以优化面板的数据展示效果，使最重要的数据更加突出。这在处理多指标面板时特别有用。
:::

## 面板高级配置

开启“高级”以后，您这里可以添加多个高级 SQL 的查询，并把查询结果同时显示在同一个面板里面。

在每个高级 SQL 查询里面，您可以选择下面两种类型的查询：

1. **TDengine**：使用当前元素或者元素模板关联的 TDengine 连接进行查询。
2. **事件（Event）**：查询系统内部生成的事件。

在输入完整的 SQL 查询以后，您可以点击“验证”按钮验证当前 SQL 是否合法可执行。验证成功后会在该按钮旁边显示绿色图标表示通过。这个时候可以点击下面两个选择框进行选择：

1. **时间列**：您如果希望使用查询结果的某个列为时间列，可以选择或者取消选择。
2. **维度**：您如果希望把结果列的一些列设置为维度，可以选择一个或者多个列作为维度列。

高级查询还支持下面三个替换参数：

1. `${FROM_TIME}`: 在面板或者仪表板中使用，用于替换时间选择器的开始时间
2. `${TO_TIME}`: 在面板或者仪表板中使用，用于替换时间选择器的结束时间
3. `${Element#fullVirtualTable}`：在元素模板中使用，用于替换面板或者仪表板的元素选择器传入的元素的完整虚拟表

:::note

1. 以上参数均支持自动补全：在 SQL 编辑器中，输入 `FROM_TIME` 可自动补全为 `${FROM_TIME}`，输入 `TO_TIME` 可自动补全为 `${TO_TIME}`，输入 `ELEMENT` 可自动补全为 `${Element#fullVirtualTable}`
2. 参数 `${FROM_TIME}` 和 `${TO_TIME}` 在被替换时，会根据上下文，自动判断是否添加单引号，使用参数时，无需添加
3. 参数 `${Element#fullVirtualTable}` 在被替换时，会根据上下文，自动判断是否添加反引号，使用参数时，无需添加

:::

另外，可以点击“格式化”图标对当前 SQL 语句进行格式化，同时可以启用或者暂时不启用当前 SQL。

## 面板的可视化设置

面板处于编辑状态时，点击面板上方动作区最右侧的按钮，可以对展示做各种配置。每种面板的可视化配置参数与 Grafana 高度一致，而且因为配置的修改都将立即展示出来，所见即所得，因此本文档将不做专门介绍。

## 面板卡片或者列表

面板列表默认以卡片方式展示，可切换为列表方式。每个面板可通过菜单进行查看、编辑、删除、转换为模板等操作。若面板未包含子元素属性，可转换为模板。
